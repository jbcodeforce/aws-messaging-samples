<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jerome Boyer"><link href=../ rel=prev><link href=../../../req-reply-jms/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.27"><title>S3-multi-tenant-event - AWS Messaging Studies</title><link rel=stylesheet href=../../../assets/stylesheets/main.6543a935.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#process-s3-events-for-multi-tenant-bucket-with-eda class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="AWS Messaging Studies" class="md-header__button md-logo" aria-label="AWS Messaging Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AWS Messaging Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> S3-multi-tenant-event </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/aws-messaging-study.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="AWS Messaging Studies" class="md-nav__button md-logo" aria-label="AWS Messaging Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> AWS Messaging Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/aws-messaging-study.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../../activemq/ class=md-nav__link> <span class=md-ellipsis> Active MQ </span> </a> </li> <li class=md-nav__item> <a href=../../../amazonmq/ class=md-nav__link> <span class=md-ellipsis> Amazon MQ </span> </a> </li> <li class=md-nav__item> <a href=../../../sqs/ class=md-nav__link> <span class=md-ellipsis> Amazon SQS </span> </a> </li> <li class=md-nav__item> <a href=../../../sns/ class=md-nav__link> <span class=md-ellipsis> Amazon SNS </span> </a> </li> <li class=md-nav__item> <a href=../../../rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Rabbit MQ </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Labs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Labs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> <span class=md-ellipsis> Active MQ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> Active MQ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aq-aws-console-lab/ class=md-nav__link> <span class=md-ellipsis> Via AWS Console </span> </a> </li> <li class=md-nav__item> <a href=../../activemq-monitoring/ class=md-nav__link> <span class=md-ellipsis> ActiveMQ monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../activemq-ldap-sec/ class=md-nav__link> <span class=md-ellipsis> Active MQ security </span> </a> </li> <li class=md-nav__item> <a href=../../ow-pt-to-pt-jms/ class=md-nav__link> <span class=md-ellipsis> One way pt-to-pt JMS </span> </a> </li> <li class=md-nav__item> <a href=../../activemq-cdk/ class=md-nav__link> <span class=md-ellipsis> ActiveMQ with CDK </span> </a> </li> <li class=md-nav__item> <a href=../../failover-lab/ class=md-nav__link> <span class=md-ellipsis> Failover to standby </span> </a> </li> <li class=md-nav__item> <a href=../../classic-req-reply-jms/ class=md-nav__link> <span class=md-ellipsis> JMS Req-ReplyTo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2 checked> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> <span class=md-ellipsis> SQS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=true> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> SQS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Basic </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> S3-multi-tenant-event </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> S3-multi-tenant-event </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#constraints-and-constructs class=md-nav__link> <span class=md-ellipsis> Constraints and constructs </span> </a> </li> <li class=md-nav__item> <a href=#limits class=md-nav__link> <span class=md-ellipsis> Limits </span> </a> </li> <li class=md-nav__item> <a href=#event-content class=md-nav__link> <span class=md-ellipsis> Event Content </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#potential-solutions class=md-nav__link> <span class=md-ellipsis> Potential Solutions </span> </a> <nav class=md-nav aria-label="Potential Solutions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#defining-a-group-of-tenants class=md-nav__link> <span class=md-ellipsis> Defining a group of tenants </span> </a> </li> <li class=md-nav__item> <a href=#sqs-only class=md-nav__link> <span class=md-ellipsis> SQS only </span> </a> </li> <li class=md-nav__item> <a href=#s3-to-lambda-to-sqs class=md-nav__link> <span class=md-ellipsis> S3 to Lambda to SQS </span> </a> </li> <li class=md-nav__item> <a href=#sns-sqs class=md-nav__link> <span class=md-ellipsis> SNS - SQS </span> </a> </li> <li class=md-nav__item> <a href=#sqs-event-bridge class=md-nav__link> <span class=md-ellipsis> SQS - Event Bridge </span> </a> </li> <li class=md-nav__item> <a href=#sqs-msk class=md-nav__link> <span class=md-ellipsis> SQS - MSK </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> <li class=md-nav__item> <a href=#sources-of-information class=md-nav__link> <span class=md-ellipsis> Sources of information </span> </a> </li> <li class=md-nav__item> <a href=#project-status class=md-nav__link> <span class=md-ellipsis> Project Status </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../req-reply-jms/ class=md-nav__link> <span class=md-ellipsis> Artemis JMS Req-ReplyTo </span> </a> </li> <li class=md-nav__item> <a href=../../ibm-mq/ class=md-nav__link> <span class=md-ellipsis> IBM MQ labs </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#constraints-and-constructs class=md-nav__link> <span class=md-ellipsis> Constraints and constructs </span> </a> </li> <li class=md-nav__item> <a href=#limits class=md-nav__link> <span class=md-ellipsis> Limits </span> </a> </li> <li class=md-nav__item> <a href=#event-content class=md-nav__link> <span class=md-ellipsis> Event Content </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#potential-solutions class=md-nav__link> <span class=md-ellipsis> Potential Solutions </span> </a> <nav class=md-nav aria-label="Potential Solutions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#defining-a-group-of-tenants class=md-nav__link> <span class=md-ellipsis> Defining a group of tenants </span> </a> </li> <li class=md-nav__item> <a href=#sqs-only class=md-nav__link> <span class=md-ellipsis> SQS only </span> </a> </li> <li class=md-nav__item> <a href=#s3-to-lambda-to-sqs class=md-nav__link> <span class=md-ellipsis> S3 to Lambda to SQS </span> </a> </li> <li class=md-nav__item> <a href=#sns-sqs class=md-nav__link> <span class=md-ellipsis> SNS - SQS </span> </a> </li> <li class=md-nav__item> <a href=#sqs-event-bridge class=md-nav__link> <span class=md-ellipsis> SQS - Event Bridge </span> </a> </li> <li class=md-nav__item> <a href=#sqs-msk class=md-nav__link> <span class=md-ellipsis> SQS - MSK </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> <li class=md-nav__item> <a href=#sources-of-information class=md-nav__link> <span class=md-ellipsis> Sources of information </span> </a> </li> <li class=md-nav__item> <a href=#project-status class=md-nav__link> <span class=md-ellipsis> Project Status </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=process-s3-events-for-multi-tenant-bucket-with-eda>Process S3 events for multi-tenant bucket with EDA<a class=headerlink href=#process-s3-events-for-multi-tenant-bucket-with-eda title="Permanent link">&para;</a></h1> <details class=info open=open> <summary>Info</summary> <p><strong>Created:</strong> Dec 2023 - Updated: <strong>01/26/24</strong>. State: Draft</p> </details> <p>This study reviews, how to best support the Amazon S3 Event Notification processing, using an event-driven processing approach to help an software vendor computing the storage usage of its users in a multi-tenancy architecture.</p> <p>As in any event-driven solution, the choice of implementation approaches will depend of the requirements (Confucius may have already said it), this article addresses a multi-tenancy use case, for S3 notification event processing at scale.</p> <p>I cover different messaging technologies like Amazon SQS, SNS, AWS Event Bridge or streaming platform like Kafka.</p> <p>The goal is to help developers or solution architects review the possible solutions and select the most appropriate one to address their own problem. The problem is generic enough to represent a reusable solution.</p> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>The implementation demonstration in this <a href=https://github.com/jbcodeforce/aws-messaging-study/tree/main/SQS/s3-event-processing>repository/folder</a> is to mockup a SaaS multi-tenant application using S3 as Data Lake and an asynchronous event-driven processing to address <strong>S3 put or update object</strong> event notifications with a goal to support 100k+ tenants.</p> <p>Each bucket has top level prefixes assigned to a unique tenant. Within a prefix, user can have a hierarchy of 'folders' and objects. It is a multi-tenancy segregation pattern at the prefix level. The following figure illustrates a simple example of bucket and prefix per tenant organization:</p> <div class=highlight><pre><span></span><code>tenant-group-1<span class=w> </span><span class=o>(</span>bucket<span class=o>)</span>
├──<span class=w> </span>tenant_1
│<span class=w>   </span>├──<span class=w> </span>raw
│<span class=w>   </span>│<span class=w>   </span>├──<span class=w> </span>object_10
│<span class=w>   </span>│<span class=w>   </span>└──<span class=w> </span>object_11
│<span class=w>   </span>└──<span class=w> </span>silver
│<span class=w>   </span>│<span class=w>   </span>├──<span class=w> </span>object_20
│<span class=w>   </span>│<span class=w>   </span>└──<span class=w> </span>object_21
├──<span class=w> </span>tenant_2
└──<span class=w> </span>tenant_3
</code></pre></div> <ul> <li>To control file upload, a tool will take into account the tenant's unique identifier so the system can map the target S3 object prefix to a tenant.</li> <li>The solution needs to support million of files uploaded to S3 per day, at a rate of 200k file moves per minute. Once a file is uploaded (in <code>raw</code> prefix), there are file processors that transform the file into another format (the demonstration in this repository, uses Iceberg) to save in another prefix (<code>silver</code>). The basic processing, for a unique tenant, looks like in following figure:</li> </ul> <p><img alt src=../diagrams/s3event-processing.drawio.png width=900></p> <p><strong>Figure 1: Single tenant processing</strong></p> <ul> <li>The event-driven processor can directly get messages from the SQS queue, using AWS SDK. It has to manage idempotency as S3 Event notification may generate retries, so delivering the same message multiple times.</li> <li>The SaaS platform needs to support hundred of those event-driven processing in parallel, at least one per tenant.</li> <li>The SaaS AWS account is the owner of the buckets, and any queues, or topics used for the solution.</li> </ul> <h3 id=constraints-and-constructs>Constraints and constructs<a class=headerlink href=#constraints-and-constructs title="Permanent link">&para;</a></h3> <ul> <li>An AWS account can have a maximum of 100 buckets per region per account. This is a soft limit.</li> <li>There is no limit on the number of objects stored within a bucket. No limit in the number of prefixes. However, a spike in the API request (on create and update objects) rate might cause throttling. In S3, partitions exist at the prefix level, and not at the object level. S3 doesn't use hierarchy to organize its objects and files. A folder is the value between the two slash (/) characters within the prefix name.</li> <li>S3 supports configuring event notifications on a <strong>per-bucket</strong> basis, to send events to other AWS services like AWS Lambda, SNS or SQS.</li> <li>As the event-processing job will create new file in another prefix, to avoid looping, the event notification needs to take into account the prefixes. We could use another bucket for the target of the file processing, but to keep tenancy within the constraint of a unique bucket, prefixes are also used.</li> <li>The S3 storage class is <code>Standard</code> or <code>S3 Express one Zone</code>.</li> <li> <p>Each S3 bucket can have up to 100 event notification configurations. A configuration defines the event types to send from S3 and what filters to apply to the event by using the prefix and suffix attributes of the S3 objects:</p> <p><img alt src=../images/evt-noti-evt-types.png></p> <p><strong>Figure 2: Defining S3 event notification in AWS Console</strong></p> <p>With the potential destination to publish the events to:</p> <p><img alt src=../images/evt-notif-dest.png></p> <p><strong>Figure 3: Destination for the events</strong> </p> </li> <li> <p>Below is an example of <a href=https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_s3_notifications.html>Python AWS CDK</a> code to define event notification configuration for ObjectCreated event on bucket <code>tenant-group-1</code>, prefix: <code>tenant-1/raw</code>.</p> <div class=highlight><pre><span></span><code><span class=n>queue</span> <span class=o>=</span> <span class=n>sqs</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> 
                      <span class=s1>&#39;tenant-grp-1&#39;</span><span class=p>,</span>
                      <span class=n>queue_name</span><span class=o>=</span><span class=s1>&#39;tenant-grp-1&#39;</span><span class=p>,</span>
                      <span class=n>retention_period</span><span class=o>=</span><span class=n>Duration</span><span class=o>.</span><span class=n>days</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span>
                      <span class=n>encryption</span><span class=o>=</span><span class=n>sqs</span><span class=o>.</span><span class=n>QueueEncryption</span><span class=o>.</span><span class=n>UNENCRYPTED</span><span class=p>)</span>

<span class=n>bucket</span> <span class=o>=</span> <span class=n>s3</span><span class=o>.</span><span class=n>Bucket</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;tenant-group-1&quot;</span><span class=p>,</span>
                       <span class=n>bucket_name</span><span class=o>=</span><span class=s1>&#39;tenant-group-1&#39;</span><span class=p>,</span>
                       <span class=n>versioned</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
                       <span class=n>removal_policy</span><span class=o>=</span><span class=n>RemovalPolicy</span><span class=o>.</span><span class=n>DESTROY</span><span class=p>,</span>
                       <span class=n>auto_delete_objects</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=n>bucket</span><span class=o>.</span><span class=n>add_event_notification</span><span class=p>(</span><span class=n>s3</span><span class=o>.</span><span class=n>EventType</span><span class=o>.</span><span class=n>OBJECT_CREATED</span><span class=p>,</span> 
                            <span class=n>s3n</span><span class=o>.</span><span class=n>SqsDestination</span><span class=p>(</span><span class=n>queue</span><span class=p>),</span>
                            <span class=n>NotificationKeyFilter</span><span class=p>(</span> <span class=n>prefix</span><span class=o>=</span><span class=s2>&quot;tenant-1/raw&quot;</span><span class=p>)</span>
                            <span class=p>)</span>
</code></pre></div> </li> <li> <p>Notifications are asynchronous: S3 will queue events and will retry delivery if destinations are unavailable. This avoids blocking the caller.</p> </li> <li>For demonstration purpose, we will process ObjectCreated events. See <a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/notification-how-to-event-types-and-destinations.html#supported-notification-event-types>the other supported notifications for SQS</a> and <a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html>for the ones in EventBridge</a>. Also CDK is quite static and works well with infrastructure as code and CI/CD practices. For this demonstration SDK may be a better solution to demonstrate the flexibility of the SaaS platform to add tenant dynamically: we can imagine a <code>create tenant</code> API that provisions a prefix and assigns it to an existing bucket dynamically.</li> <li>On rare occasion, S3 retry mechanism might cause duplicate S3 event notification.</li> <li>Event ordering: S3 event notification to SQS FIFO is not supported. Event Notification includes a Sequencer attribute which can be used to determine the order of events for a given object key. Sequencer provides a way to determine the sequence of events. Notifications from events that create objects (PUTs) and delete objects contain a sequencer.</li> </ul> <h3 id=limits>Limits<a class=headerlink href=#limits title="Permanent link">&para;</a></h3> <ul> <li>Number of bucket per region per account: 100.</li> <li>S3 request performance: 3,500 PUT/COPY/POST/DELETE or 5,500 GET/HEAD requests per second per partitioned Amazon S3 prefix. So in this example, it will be per tenant. 200k file uploads per minute should create around 3350 events per second.</li> <li>Number of S3 Event Notification: 100 events.</li> <li>S3 event notifications do not natively support event batching.</li> </ul> <h3 id=event-content>Event Content<a class=headerlink href=#event-content title="Permanent link">&para;</a></h3> <p>The S3 <a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/notification-content-structure.html>Event notification includes metadata</a> about the bucket access done and the object created (<em>not all fields are reported in following json</em>): </p> <div class=highlight><pre><span></span><code><span class=p>{</span>
<span class=w>    </span><span class=nt>&quot;Records&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=nt>&quot;eventVersion&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.1&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=nt>&quot;eventSource&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;aws:s3&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=nt>&quot;awsRegion&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;us-west-2&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=nt>&quot;eventTime&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2023-12-22T01:13:20.539Z&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=nt>&quot;eventName&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ObjectCreated:Put&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=nt>&quot;userIdentity&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>                </span><span class=nt>&quot;principalId&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;...&quot;</span>
<span class=w>            </span><span class=p>},</span>
<span class=w>            </span><span class=nt>&quot;s3&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>                </span><span class=nt>&quot;s3SchemaVersion&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1.0&quot;</span><span class=p>,</span>
<span class=w>                </span><span class=nt>&quot;configurationId&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;.....jU4&quot;</span><span class=p>,</span>
<span class=w>                </span><span class=nt>&quot;bucket&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;tenant-group-1&quot;</span><span class=p>,</span>
<span class=w>                    </span><span class=nt>&quot;ownerIdentity&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>                        </span><span class=nt>&quot;principalId&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;...&quot;</span>
<span class=w>                    </span><span class=p>},</span>
<span class=w>                    </span><span class=nt>&quot;arn&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:s3:::tenantgroup1....ddfgox&quot;</span>
<span class=w>                </span><span class=p>},</span>
<span class=w>                </span><span class=nt>&quot;object&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>                    </span><span class=nt>&quot;key&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;raw/reports.csv&quot;</span><span class=p>,,</span>
<span class=w>                    </span><span class=nt>&quot;eTag&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;138....79aa&quot;</span><span class=p>,</span>
<span class=w>                    </span><span class=nt>&quot;sequencer&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;00....99D&quot;</span>
<span class=w>                </span><span class=p>}</span>
<span class=w>            </span><span class=p>}</span>
<span class=w>        </span><span class=p>}</span>
<span class=w>    </span><span class=p>]</span>
<span class=p>}</span>
</code></pre></div> <p>Example of Python code to access the object's path,</p> <div class=highlight><pre><span></span><code> <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>events</span><span class=p>[</span><span class=s2>&quot;Records&quot;</span><span class=p>]:</span>
    <span class=n>bucket</span> <span class=o>=</span> <span class=n>record</span><span class=p>[</span><span class=s2>&quot;s3&quot;</span><span class=p>][</span><span class=s2>&quot;bucket&quot;</span><span class=p>]</span>
    <span class=n>objectName</span><span class=o>=</span><span class=n>record</span><span class=p>[</span><span class=s2>&quot;s3&quot;</span><span class=p>][</span><span class=s2>&quot;object&quot;</span><span class=p>][</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>bucket</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>objectName</span><span class=p>)</span>
</code></pre></div> <h2 id=potential-solutions>Potential Solutions<a class=headerlink href=#potential-solutions title="Permanent link">&para;</a></h2> <p>In the figure 1 above, we were using SQS queue to support the asynchronous event processing with persistence. As there will be multi-tenant per bucket, we need to fan out the processing per tenant.</p> <h3 id=defining-a-group-of-tenants>Defining a group of tenants<a class=headerlink href=#defining-a-group-of-tenants title="Permanent link">&para;</a></h3> <p>Below is a simple tenant group definition for one S3 bucket and one unique queue:</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
<span class=w>   </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;tenant-group-1&quot;</span><span class=p>,</span>
<span class=w>   </span><span class=nt>&quot;bucket&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;ACCOUNTID&gt;-tenant-group-1&quot;</span><span class=p>,</span>
<span class=w>   </span><span class=nt>&quot;region&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;us-west-2&quot;</span><span class=p>,</span>
<span class=w>   </span><span class=nt>&quot;queueURL&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;https://sqs.us-west-2.amazonaws.com/ACCOUNTID/tenant-group-1&quot;</span><span class=p>,</span>
<span class=w>   </span><span class=nt>&quot;queueArn&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:sqs:us-west-2:ACCOUNTID:tenant-group-1&quot;</span><span class=p>,</span>
<span class=w>   </span><span class=nt>&quot;status&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ACTIVE&quot;</span>
<span class=p>}</span>
</code></pre></div> <p>See the Python code to <a href=https://github.com/jbcodeforce/aws-messaging-study/blob/main/SQS/s3-sqs-fanout/createGroupTenant.py>create tenant group</a> for demonstration purpose.</p> <p>When onboarding a tenant, the platform defines a unique <code>tenant_id</code>, and links it to the target bucket and prefix within a persisted Hash Map. This will be used by the SaaS SDK to put the file in the good <code>bucket / 'folder'</code>. The following json may be persisted in DynamoDB.</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
<span class=w>    </span><span class=nt>&quot;Name&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;tenant-1&quot;</span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;RootS3Bucket&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;40....6-tenant-group-1&quot;</span><span class=p>},</span><span class=w> </span>
<span class=w>    </span><span class=nt>&quot;Region&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;us-west-2&quot;</span><span class=p>},</span><span class=w> </span>
<span class=w>    </span><span class=nt>&quot;Status&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ACTIVE&quot;</span><span class=p>},</span><span class=w> </span>
<span class=w>    </span><span class=nt>&quot;BasePrefix&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;tenant-1/&quot;</span><span class=p>},</span><span class=w> </span>
<span class=w>    </span><span class=nt>&quot;GroupName&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;tenant-group-1&quot;</span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;ProcessorURL&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;S&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;https://&quot;</span><span class=p>}</span>
<span class=p>}</span><span class=w>    </span>
</code></pre></div> <h3 id=sqs-only>SQS only<a class=headerlink href=#sqs-only title="Permanent link">&para;</a></h3> <p>The following approach illustrates the simplest asynchronous architecture, using different S3 event notifications based on prefixes and a unique queue per tenant.</p> <p><img alt src=../diagrams/s3-sqs-fanout.drawio.png width=900></p> <p><strong>Figure 5: S3 event notification to SQS tenant queue</strong></p> <ul> <li>There will be a limit of 100, S3 event notifications, per bucket. This seems to be a hard limit. Having 1000 bucket per account per region with 100 event notifications, should support around 100k tenants.</li> <li> <p>Using event notification definition, we can fan-out at the level of the event notification definition, one SQS queue per tenant. Below is a code sample to create the S3 event notification to target a SQS queue, and dedicated per tenant via the prefix name:</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>eventNotificationPerTenant</span><span class=p>(</span><span class=n>tenantName</span><span class=p>,</span><span class=n>bucketName</span><span class=p>,</span><span class=n>queueArn</span><span class=p>):</span>
<span class=n>response</span> <span class=o>=</span> <span class=n>s3</span><span class=o>.</span><span class=n>put_bucket_notification_configuration</span><span class=p>(</span>
            <span class=n>Bucket</span><span class=o>=</span><span class=n>bucketName</span><span class=p>,</span>
            <span class=n>NotificationConfiguration</span><span class=o>=</span> <span class=p>{</span>
                <span class=s1>&#39;QueueConfigurations&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span>
                    <span class=s1>&#39;QueueArn&#39;</span><span class=p>:</span> <span class=n>queueArn</span><span class=p>,</span>
                    <span class=s1>&#39;Events&#39;</span><span class=p>:</span> <span class=p>[</span>
                        <span class=s1>&#39;s3:ObjectCreated:*&#39;</span><span class=o>|</span><span class=s1>&#39;s3:ObjectRemoved:*&#39;</span><span class=o>|</span><span class=s1>&#39;s3:ObjectRestore:*&#39;</span><span class=o>|</span> <span class=s1>&#39;s3:Replication:*&#39;</span>
                    <span class=p>],</span>
                    <span class=s1>&#39;Filter&#39;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=s1>&#39;Key&#39;</span><span class=p>:</span> <span class=p>{</span>
                            <span class=s1>&#39;FilterRules&#39;</span><span class=p>:</span> <span class=p>[</span>
                                <span class=p>{</span>
                                    <span class=s1>&#39;Name&#39;</span><span class=p>:</span> <span class=s1>&#39;prefix&#39;</span><span class=p>,</span>
                                    <span class=s1>&#39;Value&#39;</span><span class=p>:</span> <span class=n>tenantName</span> <span class=o>+</span> <span class=s2>&quot;/raw&quot;</span>
                                <span class=p>},</span>
                            <span class=p>]</span>
                        <span class=p>}</span>
                    <span class=p>}</span>
                <span class=p>},</span>
            <span class=p>]})</span>
</code></pre></div> </li> <li> <p>The queue ARN will be the queue per tenant.</p> </li> <li>This approach will scale at the level of the number of event-notification that could be created per bucket.</li> <li> <p>The negative of this approach is the big number of queues and event-notifications to be created when we need to scale at hundred of thousand tenants. The filtering on the file to process will be done by the <code>event-driven transform</code> process.</p> </li> <li> <p>There is no real limit to the number of SQS queue per region per account.</p> </li> <li>Standard queues support a maximum of 120,000 inflight messages (received from the queue but not yet deleted by the consumer). </li> <li>On <a href=https://aws.amazon.com/sqs/features/ >SQS Standard queue</a> nearly unlimited number of transactions per second per API action.</li> <li>SQS is using at least once delivery semantic.</li> </ul> <h3 id=s3-to-lambda-to-sqs>S3 to Lambda to SQS<a class=headerlink href=#s3-to-lambda-to-sqs title="Permanent link">&para;</a></h3> <p>A more flexible implementation may use Lambda function as a target to S3 Event Notification, to support flexible routing and filtering implementation, use the fan-out pattern, and support batching the events. If the event-driven processing is exposed via HTTP the Lambda function may directly call the good HTTP endpoint:</p> <p><img alt src=../diagrams/s3-lambda-fanout.drawio.png width=900></p> <p><strong>Figure 6: Lambda to fanout to http endpoints</strong></p> <p>Lambda can scale at thousand of instances in parallel. The solution uses one queue per bucket and one S3 event notification definition.</p> <p>When the event-driven processing needs to be asynchronous, then we can add one queue before each event-driven process and the Lambda will send the event to the good queue.</p> <p><img alt src=../diagrams/s3-lambda-sqs-fanout.drawio.png width=900></p> <p><strong>Figure 7: Lambda to fan out to SQS queues</strong></p> <details class="- info"> <summary>Lambda as a destination to S3 Event Notification</summary> <p>The Lambda function can be a target of the S3 event notification as illustrated below:</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>eventNotificationPerTenantViaLambda</span><span class=p>(</span><span class=n>tenantName</span><span class=p>,</span><span class=n>bucketName</span><span class=p>,</span><span class=n>functionArn</span><span class=p>):</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>s3</span><span class=o>.</span><span class=n>put_bucket_notification_configuration</span><span class=p>(</span>
        <span class=n>Bucket</span><span class=o>=</span><span class=n>bucketName</span><span class=p>,</span>
        <span class=n>NotificationConfiguration</span><span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;LambdaFunctionConfigurations&#39;</span><span class=p>:</span> <span class=p>[</span>
            <span class=p>{</span>
                <span class=s1>&#39;LambdaFunctionArn&#39;</span><span class=p>:</span> <span class=n>functionArn</span><span class=p>,</span>
                <span class=s1>&#39;Events&#39;</span><span class=p>:</span> <span class=p>[</span>
                    <span class=s1>&#39;s3:ObjectCreated:*&#39;</span><span class=o>|</span><span class=s1>&#39;s3:ObjectRemoved:*&#39;</span><span class=o>|</span><span class=s1>&#39;s3:ObjectRestore:*&#39;</span><span class=o>|</span> <span class=s1>&#39;s3:Replication:*&#39;</span><span class=o>|</span><span class=s1>&#39;s3:LifecycleTransition&#39;</span><span class=o>|</span><span class=s1>&#39;s3:IntelligentTiering&#39;</span><span class=o>|</span><span class=s1>&#39;s3:ObjectAcl:Put&#39;</span><span class=o>|</span><span class=s1>&#39;s3:LifecycleExpiration:*&#39;</span><span class=o>|</span><span class=s1>&#39;s3:LifecycleExpiration:Delete&#39;</span><span class=o>|</span><span class=s1>&#39;s3:LifecycleExpiration:DeleteMarkerCreated&#39;</span><span class=o>|</span><span class=s1>&#39;s3:ObjectTagging:*&#39;</span><span class=p>,</span>
                <span class=p>],</span>
                <span class=s1>&#39;Filter&#39;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=s1>&#39;Key&#39;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=s1>&#39;FilterRules&#39;</span><span class=p>:</span> <span class=p>[</span>
                            <span class=p>{</span>
                            <span class=s1>&#39;Name&#39;</span><span class=p>:</span> <span class=s1>&#39;prefix&#39;</span><span class=p>,</span>
                                <span class=s1>&#39;Value&#39;</span><span class=p>:</span> <span class=n>tenantName</span> <span class=o>+</span> <span class=s2>&quot;/raw&quot;</span>
                            <span class=p>},</span>
                        <span class=p>]</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>},</span>
            <span class=p>]</span>
        <span class=p>},</span>
        <span class=p>)</span>
</code></pre></div> <p>Except that the S3 Event notification is posted to an internal queue in the Lambda service. But this queue is transparent to the developer.</p> </details> <p>For the Lambda routing implementation, Lambda will automatically deletes the message from the queue if it returns a success status.</p> <p>The pricing model is pay per call, duration and memory used.</p> <p>See a proof of concept implementation of the following deployment:</p> <p><img alt src=../diagrams/demo-1-e2e.drawio.png width=900></p> <p>with demonstration script in <a href=https://github.com/jbcodeforce/aws-messaging-study/tree/main/SQS/s3-event-processing>this folder</a>.</p> <h3 id=sns-sqs>SNS - SQS<a class=headerlink href=#sns-sqs title="Permanent link">&para;</a></h3> <p>In many Fan-out use cases, one of the solution is to combine SNS with SQS. The S3 event notification target is now a SNS topic. S3 Event notifications are pushed once in a SNS Service, and the SQS queues are subscribers to the topic and then get the messages.</p> <p><img alt src=../diagrams/s3-sns-sqs-fanout.drawio.png></p> <p>The advantages:</p> <ul> <li>Fully decoupled with no data loss as SQS will always listen to SNS topic.</li> <li>SQS adds data persistence, delayed processing and retries of work.</li> <li>Increase the number of subscriber over time.</li> <li>Can use Message Filtering using a JSON policy. But there are limits on the number of subscription filter policies: 200 per topic.</li> <li>Can be used for cross-region delivery, with a SQS queue in another region.</li> </ul> <p>The disadvantages:</p> <ul> <li>There is a limit on the number of filter policies. The solution is to add filtering logic within a Lambda function, which will only be relevant if there are other subscribers to the SNS topic for other type of event processing, like analytics. If there is no other consumer then the S3-&gt; SQS -&gt; Lambda -&gt; SQS solution may be more appropriate.</li> </ul> <p><img alt src=../diagrams/s3-sns-lambda-e2e.drawio.png width=900></p> <h3 id=sqs-event-bridge>SQS - Event Bridge<a class=headerlink href=#sqs-event-bridge title="Permanent link">&para;</a></h3> <p>Event Bridge could be a solution if the S3 event processing is exposed with HTTP endpoint. Routing rule will be used to select the target end-point depending of the tenant information. But there is a limit of 2000 rules per event bus, so it may not be a valid solution to address the use case of thousand of tenants.</p> <p><img alt src=../diagrams/s3-sqs-eb-fanout.drawio.png width=900></p> <p>Also S3 Event Notifications can be sent to the default event bus only, we may need different buses.</p> <h3 id=sqs-msk>SQS - MSK<a class=headerlink href=#sqs-msk title="Permanent link">&para;</a></h3> <p>Finally Kafka may be a solution to stream the S3 event notification to it, via a SQS queue. The interest of this solution, will be to enable event replay and really embrace an event-driven architecture where any consumers may come to consume messages and use an event-sourcing pattern.</p> <p><img alt src=../diagrams/s3-sqs-msk-fanout.drawio.png width=900></p> <p>It may be more complex to deploy as we need to define a MSK cluster, and Kafka Connect - SQS source connector. The Event-driven processes need to consume from Kafka. Event ordering will be kept. It will scale to thousand of consumers. This will be a recommended approach when such events are becoming events that can be consumed by many different consumers.</p> <h2 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">&para;</a></h2> <p>For a cost perspective, scale to zero is very important, as the solution deployment does not need to get computers waiting for events to come. The Lambda with SQS queues seems the most appropriate method to address the multi-tenant at scale requirements of this solution. As an alternate approach, using a long term strategy of doing an event-driven architecture then Kafka based solution will be a better choice. </p> <h2 id=sources-of-information>Sources of information<a class=headerlink href=#sources-of-information title="Permanent link">&para;</a></h2> <ul> <li><a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventNotifications.html>Product documentation - Amazon S3 Event Notifications</a></li> <li><a href=https://aws.amazon.com/blogs/storage/manage-event-ordering-and-duplicate-events-with-amazon-s3-event-notifications/ >Manage event ordering and duplicate events with Amazon S3 Event Notifications - blog</a></li> <li><a href=https://aws.amazon.com/blogs/storage/getting-visibility-into-storage-usage-in-multi-tenant-amazon-s3-buckets/ >Getting visibility into storage usage in multi-tenant Amazon S3 buckets</a></li> </ul> <h2 id=project-status>Project Status<a class=headerlink href=#project-status title="Permanent link">&para;</a></h2> <p>01/2024:</p> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> Python SDK to create a tenant group with one matching SQS queue. Define S3 Event Notification from the bucket to SQS. Keep information of the tenant group in DynamoDB.</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> Python SDK to create a new tenant within a given group: create a prefix under the bucket for raw and silver prefixes. Create a SQS per tenant. Persist information about a tenant in DynamoDB.</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> Python SDK app to write a file to S3 bucket for a tenant.</li> <li class=task-list-item> <p><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> From the tenant_group SQS queue to Lambda event routing function to SQS using SAM</p> </li> <li class=task-list-item> <p><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> S3 event notifications to SNS to Lambda to SQS using SAM</p> </li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> CDK to create S3 bucket <code>tenant-grp-2</code> and Event notification to SNS topic <code>tenant-grp-2</code></li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ class="md-footer__link md-footer__link--prev" aria-label="Previous: Basic"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Basic </div> </div> </a> <a href=../../../req-reply-jms/ class="md-footer__link md-footer__link--next" aria-label="Next: Artemis JMS Req-ReplyTo"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Artemis JMS Req-ReplyTo </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.ad660dcc.min.js></script> </body> </html>
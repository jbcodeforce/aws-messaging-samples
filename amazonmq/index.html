<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jerome Boyer"><link href=../activemq/ rel=prev><link href=../sqs/ rel=next><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.27"><title>Amazon MQ - AWS Messaging Studies</title><link rel=stylesheet href=../assets/stylesheets/main.6543a935.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#amazon-mq class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="AWS Messaging Studies" class="md-header__button md-logo" aria-label="AWS Messaging Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AWS Messaging Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Amazon MQ </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/aws-messaging-study.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="AWS Messaging Studies" class="md-nav__button md-logo" aria-label="AWS Messaging Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> AWS Messaging Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/aws-messaging-study.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../activemq/ class=md-nav__link> <span class=md-ellipsis> Active MQ </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Amazon MQ </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Amazon MQ </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#value-propositions class=md-nav__link> <span class=md-ellipsis> Value propositions </span> </a> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance considerations </span> </a> </li> <li class=md-nav__item> <a href=#pricing class=md-nav__link> <span class=md-ellipsis> Pricing </span> </a> </li> <li class=md-nav__item> <a href=#monitoring class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> <li class=md-nav__item> <a href=#maintenance class=md-nav__link> <span class=md-ellipsis> Maintenance </span> </a> </li> <li class=md-nav__item> <a href=#topology class=md-nav__link> <span class=md-ellipsis> Topology </span> </a> <nav class=md-nav aria-label=Topology> <ul class=md-nav__list> <li class=md-nav__item> <a href=#active-standby class=md-nav__link> <span class=md-ellipsis> Active Standby </span> </a> </li> <li class=md-nav__item> <a href=#mesh class=md-nav__link> <span class=md-ellipsis> Mesh </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-considerations class=md-nav__link> <span class=md-ellipsis> Security considerations </span> </a> <nav class=md-nav aria-label="Security considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ldap-integration class=md-nav__link> <span class=md-ellipsis> LDAP integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#faqs class=md-nav__link> <span class=md-ellipsis> FAQs </span> </a> </li> <li class=md-nav__item> <a href=#good-sources-of-information class=md-nav__link> <span class=md-ellipsis> Good sources of information </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../sqs/ class=md-nav__link> <span class=md-ellipsis> Amazon SQS </span> </a> </li> <li class=md-nav__item> <a href=../sns/ class=md-nav__link> <span class=md-ellipsis> Amazon SNS </span> </a> </li> <li class=md-nav__item> <a href=../rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Rabbit MQ </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Labs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Labs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> <span class=md-ellipsis> Active MQ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> Active MQ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../labs/aq-aws-console-lab/ class=md-nav__link> <span class=md-ellipsis> Via AWS Console </span> </a> </li> <li class=md-nav__item> <a href=../labs/activemq-monitoring/ class=md-nav__link> <span class=md-ellipsis> ActiveMQ monitoring </span> </a> </li> <li class=md-nav__item> <a href=../labs/activemq-ldap-sec/ class=md-nav__link> <span class=md-ellipsis> Active MQ security </span> </a> </li> <li class=md-nav__item> <a href=../labs/ow-pt-to-pt-jms/ class=md-nav__link> <span class=md-ellipsis> One way pt-to-pt JMS </span> </a> </li> <li class=md-nav__item> <a href=../labs/activemq-cdk/ class=md-nav__link> <span class=md-ellipsis> ActiveMQ with CDK </span> </a> </li> <li class=md-nav__item> <a href=../labs/failover-lab/ class=md-nav__link> <span class=md-ellipsis> Failover to standby </span> </a> </li> <li class=md-nav__item> <a href=../labs/classic-req-reply-jms/ class=md-nav__link> <span class=md-ellipsis> JMS Req-ReplyTo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> <span class=md-ellipsis> SQS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> SQS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../labs/sqs/ class=md-nav__link> <span class=md-ellipsis> Basic </span> </a> </li> <li class=md-nav__item> <a href=../labs/sqs/s3-tenants-async-processing/ class=md-nav__link> <span class=md-ellipsis> S3-multi-tenant-event </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../req-reply-jms/ class=md-nav__link> <span class=md-ellipsis> Artemis JMS Req-ReplyTo </span> </a> </li> <li class=md-nav__item> <a href=../labs/ibm-mq/ class=md-nav__link> <span class=md-ellipsis> IBM MQ labs </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#value-propositions class=md-nav__link> <span class=md-ellipsis> Value propositions </span> </a> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance considerations </span> </a> </li> <li class=md-nav__item> <a href=#pricing class=md-nav__link> <span class=md-ellipsis> Pricing </span> </a> </li> <li class=md-nav__item> <a href=#monitoring class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> <li class=md-nav__item> <a href=#maintenance class=md-nav__link> <span class=md-ellipsis> Maintenance </span> </a> </li> <li class=md-nav__item> <a href=#topology class=md-nav__link> <span class=md-ellipsis> Topology </span> </a> <nav class=md-nav aria-label=Topology> <ul class=md-nav__list> <li class=md-nav__item> <a href=#active-standby class=md-nav__link> <span class=md-ellipsis> Active Standby </span> </a> </li> <li class=md-nav__item> <a href=#mesh class=md-nav__link> <span class=md-ellipsis> Mesh </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-considerations class=md-nav__link> <span class=md-ellipsis> Security considerations </span> </a> <nav class=md-nav aria-label="Security considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ldap-integration class=md-nav__link> <span class=md-ellipsis> LDAP integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#faqs class=md-nav__link> <span class=md-ellipsis> FAQs </span> </a> </li> <li class=md-nav__item> <a href=#good-sources-of-information class=md-nav__link> <span class=md-ellipsis> Good sources of information </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=amazon-mq><a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/welcome.html>Amazon MQ</a><a class=headerlink href=#amazon-mq title="Permanent link">&para;</a></h1> <p>Amazon MQ is a managed message broker for RabbitMQ or ActiveMQ. It runs on EC2 servers, and supports multi-AZs deployment with failover.</p> <p>We can create brokers via Console (<a href=../labs/aq-aws-console-lab/ >see this lab</a>), using the AWS CLI, SDK or CDK.</p> <p>As a queueing system, when a message is received and acknowledged by one receiver, it is no longer on the queue, and the next receiver to connect gets the next message on the queue.</p> <p>Multiple senders can send messages to the same queue, and multiple receivers can receive messages from the same queue. But each message is only delivered to one receiver only.</p> <p>With topics, a consumer gets messages from when it starts to consume, previous messages will not be seen. Multiple subscribers will get the same message. All the messages sent to the topic, from any sender, are delivered to all receivers.</p> <p>The Amazon MQ Configuration is a specific object to manage the configuration of the broker. It can be created before the broker and supports Active MQ <a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-broker-configuration-parameters.html>activemq.xml configuration.</a></p> <h2 id=value-propositions>Value propositions<a class=headerlink href=#value-propositions title="Permanent link">&para;</a></h2> <ul> <li>Keep skill investment and code compatibility with existing on-premises applications.</li> <li>Reduce cost.</li> <li>Deployment automation with CloudFormation, deploy in minutes.</li> <li>Reduced operation overhead, including provisioning, updates, monitoring, maintenance, security and troubleshooting.</li> <li>Vertical scaling with EC2 instance size and type.</li> <li>Horizontal scaling through network of brokers.</li> <li>Queues and topics are in one service so we can easily fan out or build durable queue.</li> <li>Both Transient and persistent messages are supported to optimize for durability or performance.</li> <li>Lower latency.</li> <li>Support Lift and shift of existing apps to the cloud, or use an hybrid architecture.</li> </ul> <h2 id=performance-considerations>Performance considerations<a class=headerlink href=#performance-considerations title="Permanent link">&para;</a></h2> <ul> <li>The size of the message determines performance of the broker, above 100k, storage throughput is a limiting factor.</li> <li>With in-memory queue without persistence, Active MQ can reach high throughput. With no message lost goal, it uses persistence with flush at each message, and it will be bound by the I/O capacity of the underlying persistence store, EBS or EFS. <code>mq.m5.large</code>.</li> <li>To improve throughput with Amazon MQ, make sure to have consumers processing messaging as fast as, or faster than the producers are pushing messages.</li> <li>With EFS replication, with cluster and HA, throughput will be lower.</li> <li><a href=https://aws.amazon.com/blogs/compute/measuring-the-throughput-for-amazon-mq-using-the-jms-benchmark/ >Blog: "Measuring the throughput for Amazon MQ using the JMS Benchmark".</a> </li> </ul> <h2 id=pricing><a href=https://aws.amazon.com/amazon-mq/pricing/ >Pricing</a><a class=headerlink href=#pricing title="Permanent link">&para;</a></h2> <p>We pay by the hour of broker time according to the type of EC2 used as broker. The topology also impacts pricing between single, active/standby and cluster.</p> <p>Storage price is based on GB persisted on EFS in case of cluster, or EBS in case of single instance.</p> <p>Data transfer pricing applies too:</p> <ul> <li>For Traffic forwarded between brokers across availability zones in the same region</li> <li>For Traffic cross-region based on EC2 pricing. In region is not charged.</li> <li>For traffic out to the internet.</li> </ul> <h2 id=monitoring>Monitoring<a class=headerlink href=#monitoring title="Permanent link">&para;</a></h2> <p>AmazonMQ publishes <a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/security-logging-monitoring.html>utilization metrics for the brokers</a>, such as <code>CpuUtilization, HeapUsage, NetworkOut</code>. If we have a configuration with a primary and a secondary broker, we will have independent metrics for each instance.</p> <p>It also publishes metrics for queues and Topics such as <code>MemoryUsage, EnqueueCount</code> (messages published by producers), <code>DispatchCount</code> (message delivered to consumers).</p> <p><img alt src=../images/mq-metrics.png width=900></p> <p><strong>Figure 1: Queue monitoring with metrics</strong></p> <p>Using Cloudwatch alarm we can auto scale the consumer based on metrics value.</p> <p>From the AWS Amazon MQ Broker console, we can access to the Active MQ console and see the queues.</p> <p><img alt src=../images/mq-console.png width=800></p> <p><strong>Figure 2: Active MQ admin console</strong></p> <h2 id=maintenance>Maintenance<a class=headerlink href=#maintenance title="Permanent link">&para;</a></h2> <p>AWS is responsible of the hardware, OS, engine software update. Maintenance may be scheduled once a week and can take up to 2 hours. Automatic maintenance can be enforced for minor version upgrade.</p> <h2 id=topology>Topology<a class=headerlink href=#topology title="Permanent link">&para;</a></h2> <p>Amazon MQ - Active MQ supports the same topologies as the open-source version.</p> <p>In the Amazon MQ, the primary AWS resources are the Amazon MQ message broker and its configuration. The broker can be deployed in SINGLE_INSTANCE, ACTIVE_STANDBY_MULTI_AZ, or CLUSTER_MULTI_AZ. The configuration can be done <a href=../labs/aq-aws-console-lab/ >via the AWS console</a>, AWS CLI, Cloud Formation or <a href=../labs/activemq-cdk/ >CDK</a></p> <h3 id=active-standby>Active Standby<a class=headerlink href=#active-standby title="Permanent link">&para;</a></h3> <p>Active / Standby topology uses a pair of brokers in different Availability Zones. One broker gets all the connection and traffic, the other is in standby, ready to take the traffic in case of failure of the active broker. The persistence is supported by a Storage Area Network.</p> <p><img alt src=../diagrams/amq-efs-2az.drawio.png></p> <p><strong>Figure 3: Amazon MQ - Active/standby shared storage</strong></p> <p>Amazon <a href=https://docs.aws.amazon.com/efs/latest/ug/whatisefs.html>Elastic File System</a> is the serverless file system used to persist messages. We can mount the EFS file systems on on-premises data center servers when connected to the Amazon VPC with AWS Direct Connect or AWS VPN.</p> <p>For an active/standby broker, Amazon MQ provides two ActiveMQ Web Console URLs, but only one URL is active at a time. Adding failover in broker url like:</p> <div class=highlight><pre><span></span><code>failover:<span class=o>(</span>ssl://b-9f..7ac-1.mq.eu-west-2.amazonaws.com:61617,ssl://b-9f...c-2.mq.eu-west-2.amazonaws.com:61617<span class=o>)</span>
</code></pre></div> <p>ensures that whenever server goes up, it will reconnect it immediately. <a href=https://activemq.apache.org/failover-transport-reference.html>See Active MQ documentation on failover</a></p> <details class=info> <summary>Network mapping</summary> <p>On AWS, each of those failover URL are in fact mapped to IP@ of a ENI. Each broker node has two <a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/connecting-to-amazon-mq.html>ENIs connected</a> to two different networks. The <code>b-9f...-1</code> is mapped to 10.42.1.29 for example on subnet 1, while <code>b-9f...-2</code> is 10.42.0.92 to subnet 0.</p> </details> <h4 id=hybrid-cloud-with-aws>Hybrid cloud with AWS<a class=headerlink href=#hybrid-cloud-with-aws title="Permanent link">&para;</a></h4> <ul> <li> <p>During migration to the cloud, we need to support hybrid deployment where existing applications on-premises consume messages from queues or topics defined in Amazon MQ - Active MQ engine. The following diagram illustrates different possible integrations and the deployment of active/standby brokers in 2 availability zones.</p> <p><img alt src=../diagrams/on-prem-to-activemq.drawio.png></p> <p><strong>Figure 4: Hybrid integration with Amazon MQ</strong></p> <ul> <li>The on-premises applications or ETL jobs access the active broker, using public internet or private connection with Amazon Direct Connect, or site-to-site VPN.</li> <li>For the public access, the internet gateway routes the traffic to a network load balancer (layer 4 TCP routing), which is also HA (not represented in the figure), to reach the active Broker.</li> <li>The public internet traffic back from the Active MQ queue or topic to the consumer is via a NAT gateway. NAT gateways are defined in both public subnets for HA.</li> <li>When using private gateways, the VPC route tables includes routes to the CIDR of the on-premises subnets.</li> <li>Security group defines firewall like policies to authorize inbound and outbound traffic. The port for Active MQ needs to be open. Below is such declaration:</li> <li>EFS is used as a shared file system for messages persistence.</li> <li>The standby broker is linked to the active broker and ready to take the lead in case of active broker failure.</li> <li>For higher bandwidth and secured connection, Direct Connect should be used and then the communication will be via private gateway end point.</li> <li>Lambda function may be used to do light processing like data transformation, or data enrichment and then to call directly SaaS services. When more complex flow, like stateful flows, are needed, Amazon Step function can also be used (also serverless).</li> </ul> </li> </ul> <h3 id=mesh>Mesh<a class=headerlink href=#mesh title="Permanent link">&para;</a></h3> <p>Amazon MQ proposes a mesh network of single-instance brokers with non shated files as each broker uses EBS volume.</p> <p><img alt src=../diagrams/mq-mesh-single.drawio.png></p> <p><strong>Figure 5: Amazon MQ broker mesh cluster deployment</strong></p> <h2 id=security-considerations>Security considerations<a class=headerlink href=#security-considerations title="Permanent link">&para;</a></h2> <p>Active MQ is coming with its own way to define access control to Queue, Topics and Brokers. </p> <ul> <li>Access to AWS Console and Specific engine console to administrators.</li> <li>Encryption in transit via TLS.</li> <li>Encryption at rest using KMS: when creating the broker, we can select the KMS key to use to encrypt data.</li> <li>VPC support for brokers isolation and applications isolation.</li> <li>Security groups for firewall based rules.</li> <li>Queue/topic authentication and authorization using Configuration declarations.</li> <li>Integrated with CloudTrail for Amazon MQ API auditing.</li> <li>User accesses can be defined in an external LDAP, used for management Console access or for service accounts. Apps identifications are done inside the broker configuration.</li> </ul> <p>Amazon MQ uses IAM for creating, updating, and deleting operations on the message broker or configuration, and native ActiveMQ authentication for connection to brokers. The following figure illustrates those security contexts:</p> <p><img alt src=../diagrams/amq-sec-users.drawio.png></p> <p>We define three users:</p> <ol> <li>An <strong>IAM administrator</strong> who manages security within an AWS account, specifically IAM users, roles and security policies. This administrator has full access to CloudWatch logs and CloudTrail for API usage auditing. The IAM policy uses action on "mq:" prefix, and possible resources are <code>broker</code> and <code>configuration</code>. </li> <li>An <strong>MQ service administrator</strong>, manages the MQ brokers and configuration via the AWS Console, AWS CLI or APIs. This administrator should be able to define brokers and configurations, networking access controls, security groups, and may be anything related to consumer and producer apps. He/she should have access to CloudWatch Logs and CloudTrail logs too. An administrator needs to signin to amazon api and get the <a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/security-api-authentication-authorization.html#security-permissions-required-to-create-broker>permissions to act on the broker</a> and the underlying EC2 instances.</li> <li>Developer defining queue, topics, and get broker URL and credentials. Developer users can be defined in external active directory or in broker configuration file.</li> </ol> <p>Amazon MQ management operations like creating, updating and deleting brokers require IAM credentials and are not integrated with LDAP.</p> <p>As the Amazon MQ control plane will do operations on other AWS services, there is a service-linked role (<code>AWSServiceRoleForAmazonMQ</code>) defined automatically when we define a broker, with the security policies (<a href=https://console.aws.amazon.com/iam/home#policies/arn:aws:iam::aws:policy/aws-service-role/AmazonMQServiceRolePolicy>AmazonMQServiceRolePolicy</a>) to get the brokers deployed. A service-linked role is a unique type of IAM role that is linked directly to Amazon MQ.</p> <p>Amazon MQ uses ActiveMQ's Simple Authentication Plugin to restrict reading and writing to destinations. See <a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/security-authentication-authorization.html>this product documentation</a> for details.</p> <h3 id=ldap-integration>LDAP integration<a class=headerlink href=#ldap-integration title="Permanent link">&para;</a></h3> <ul> <li> <p>The LDAP integration is done via <a href=https://activemq.apache.org/security>ActiveMQ JAAS plugin</a>.</p> <p><img alt src=../diagrams/amq-ldap.drawio.png></p> </li> <li> <p>A service account, defined in LDAP, is required to initiate a connection to an LDAP server. It sets up LDAP authentication for the brokers. Client connections are authenticated through this broker-LDAP connection.</p> </li> <li>The on-premises LDAP server needs a DNS name, and be opened on port 636.</li> <li>When creating broker, we can specify the LDAP login configuration with User Base distinguished name, search filter, role base DN, role base search filter. The user base supplied to the ActiveMQ broker must point to the node in the Directory Information Tree where users are stored in the LDAP server.</li> </ul> <p>As illustrated in figure above, we have to assess the different use cases:</p> <ol> <li>A user accessing the MQ console, the authentication to the broker console will go to the LDAP server</li> <li>Applications, producers or consumers, accessing the broker using the transport Connector URL, and authenticate via a service user defined in LDAP.</li> <li>An administrator users access Amazon MQ control plane via API, using AWS CLI, to create brokers, configurations. This user needs to be part of the <code>amazonmq-console-admins</code> group.</li> </ol> <p>For user authentication via LDAP we need to define the connection to LDAP in the broker configuration file, which also includes where to search the JMS topic and queue information in the DIT:</p> <div class=highlight><pre><span></span><code><span class=nt>&lt;plugins&gt;</span>
<span class=w>    </span><span class=nt>&lt;jaasAuthenticationPlugin</span><span class=w> </span><span class=na>configuration=</span><span class=s>&quot;LdapConfiguration&quot;</span><span class=w> </span><span class=nt>/&gt;</span><span class=w> </span>
<span class=w>    </span><span class=nt>&lt;authorizationPlugin&gt;</span><span class=w> </span>
<span class=w>     </span><span class=nt>&lt;map&gt;</span><span class=w> </span>
<span class=w>       </span><span class=nt>&lt;cachedLDAPAuthorizationMap</span>
<span class=w>            </span><span class=na>queueSearchBase=</span><span class=s>&quot;ou=Queue,ou=Destination,ou=ActiveMQ,dc=systems,dc=anycompany,dc=com&quot;</span>
<span class=w>            </span><span class=na>topicSearchBase=</span><span class=s>&quot;ou=Topic,ou=Destination,ou=ActiveMQ,dc=systems,dc=anycompany,dc=com&quot;</span>
<span class=w>            </span><span class=na>tempSearchBase=</span><span class=s>&quot;ou=Temp,ou=Destination,ou=ActiveMQ,dc=systems,dc=anycompany,dc=com&quot;</span>
<span class=w>            </span><span class=na>refreshInterval=</span><span class=s>&quot;300000&quot;</span>
<span class=w>            </span><span class=na>legacyGroupMapping=</span><span class=s>&quot;false&quot;</span>
<span class=w>        </span><span class=nt>/&gt;</span>
<span class=w>         </span>...
</code></pre></div> <ul> <li>Authorization is done on a per-destination basis (or wildcard, destination set) via the <code>cachedLdapAuthorizationMap</code> element, found in the brokerâ€™s <code>activemq.xml</code>. See <a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/security-authentication-authorization.html>Amazon MQ product doc</a> for xml examples and <a href=https://activemq.apache.org/cached-ldap-authorization-module>Active MQ doc with OpenLDAP example</a>.</li> <li>In LDAP, we can define topics and queues in a Destination OU like: <code>dn: cn=carrides,ou=Queue,ou=Destination,ou=ActiveMQ,ou=systems,dc=anycompany,dc=com</code>, within those OU, either a wildcard or specific destination name can be provided (OU=ORDERS.$). Within each OU that represents a destination or a wildcard, we must create three security groups: admin, write, read, to include users or groups who have permission to perform the associated actions.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>dn</span><span class=p>:</span><span class=w> </span><span class=na>cn</span><span class=o>=</span><span class=s>admin</span><span class=p>,</span><span class=na>cn</span><span class=o>=</span><span class=s>carrides</span><span class=p>,</span><span class=na>ou</span><span class=o>=</span><span class=s>Queue</span><span class=p>,</span><span class=na>ou</span><span class=o>=</span><span class=s>Destination</span><span class=p>,</span><span class=na>ou</span><span class=o>=</span><span class=s>ActiveMQ</span><span class=p>,</span><span class=na>ou</span><span class=o>=</span><span class=s>systems</span><span class=p>,</span><span class=na>dc</span><span class=o>=</span><span class=s>anycompany</span><span class=p>,</span><span class=na>dc</span><span class=o>=</span><span class=s>com </span>
<span class=na>cn</span><span class=p>:</span><span class=err> admin </span>
<span class=na>description</span><span class=p>:</span><span class=err> Admin privilege group, members are roles </span>
<span class=na>member</span><span class=p>:</span><span class=err> cn=admin </span>
<span class=na>member</span><span class=p>:</span><span class=err> cn=webapp </span>
<span class=na>objectClass</span><span class=p>:</span><span class=err> groupOfNames </span>
<span class=na>objectClass</span><span class=p>:</span><span class=err> top </span>
</code></pre></div> <p>Adding a user to the admin security group for a particular destination will enable the user to create and delete that queue or topic.</p> <h2 id=faqs>FAQs<a class=headerlink href=#faqs title="Permanent link">&para;</a></h2> <details class="- question"> <summary>What needs to be done to migrate to Artemis</summary> <p>As of today Amazon MQ, Active MQ supports only Classic deployment and API. Moving to Artemis, means deploying on your own EC2 instances. Most of the JMS code will work or with minimum refactoring for the connection factory. The project dependencies need to be changed, the ActiveMQ connection factory class is different in term of package names, and if you use Jakarta JMS then package needs to be changed in the JMS producer and consumer classes.</p> </details> <details class="- question"> <summary>What are the CLI commands that can be run on Amazon MQ?</summary> <p>See <a href=https://awscli.amazonaws.com/v2/documentation/api/latest/reference/mq/index.html>this list</a>. To run those we need a user or an IAM role with <code>mq:</code> actions allowed. </p> </details> <details class="- question"> <summary>Support of JMX for broker and destination management?</summary> <p>Amazon MQ does not support JMX access, so queue needs to be created using code.</p> </details> <details class="- question"> <summary>what are the critical metrics / log patterns that should be monitored in respect to MQ logs?</summary> <p>Amazon CloudWatch metrics has a specific Amazon MQ dashboard with CpuUtilization, CurrentConnectionCount, networking in/ou, producer and consumer counts. We can add our own metrics using the broker or queue specific ones. The following may be of interest for storage: (See <a href=https://repost.aws/knowledge-center/mq-persistent-store-is-full-errors>this re:post</a>):</p> <ul> <li>Store Percentage Usage</li> <li>Journal Files for Full Recovery: # of journal files that are replayed after a clean shutdown.</li> <li>Journal Files for Fast Recovery: same but for unclean shutdown. (too many pending messages in storage)</li> </ul> <p>When broker starts to have memory limit for a destination, then producer flow will be throttled, even blocked. (See <a href=https://activemq.apache.org/producer-flow-control.html>this note</a>)</p> </details> <h2 id=good-sources-of-information>Good sources of information<a class=headerlink href=#good-sources-of-information title="Permanent link">&para;</a></h2> <ul> <li><a href=https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/working-with-activemq.html>Amazon MQ - Active MQ product doc</a></li> <li><a href=https://catalog.us-east-1.prod.workshops.aws/workshops/0b534eb9-fdfb-49f0-8df4-ebccca71a9eb/en-US>AWS Active MQ Workshop</a></li> <li><a href=https://github.com/aws-samples/amazon-mq-workshop.git>git amazon-mq-workshop</a></li> <li><a href=https://awscli.amazonaws.com/v2/documentation/api/latest/reference/mq/create-broker.html>Create broker AWS CLI command.</a></li> <li><a href=https://github.com/antonwierenga/amazonmq-cli>Amazon MQ CLI</a>.</li> <li><a href=https://aws.amazon.com/blogs/compute/using-amazon-mq-as-an-event-source-for-aws-lambda/ >Using Amazon MQ as an event source for AWS Lambda</a></li> <li><a href=https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/ >Implementing enterprise integration patterns with AWS messaging services: point-to-point channels.</a></li> <li><a href=https://s3.amazonaws.com/amazon-mq-workshop/CreateAmazonMQWorkshop.yaml>CloudFormation template from the MQ Workshop</a>.</li> <li><a href=https://repost.aws/knowledge-center/mq-broker-connection-issues>How do I troubleshoot Amazon MQ broker connection issues?</a>.</li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../activemq/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Active MQ"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Active MQ </div> </div> </a> <a href=../sqs/ class="md-footer__link md-footer__link--next" aria-label="Next: Amazon SQS"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Amazon SQS </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.ad660dcc.min.js></script> </body> </html>